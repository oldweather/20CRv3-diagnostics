
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Observations coverage video &#8212; Tests and analyses of version 3 of the Twentieth Century Reanalysis</title>
    <link rel="stylesheet" href="../_static/sphinxdoc.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Weather and fog in 1903" href="../fog_videos/1903.html" />
    <link rel="prev" title="Validation Spread v. Error plot January 1872 + Spring 1903 + February 1953" href="../DWR_validation/comparison.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a></li>
        <li class="right" >
          <a href="../fog_videos/1903.html" title="Weather and fog in 1903"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../DWR_validation/comparison.html" title="Validation Spread v. Error plot January 1872 + Spring 1903 + February 1953"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">20CRv3</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../_static/t2t3.png" alt="Logo"/>
            </a></p>
<h3><a href="../index.html">Table Of Contents</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tropical-storms/tropical_storms.html">Tropical Storms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../european_windstorms/european_windstorms.html">European windstorms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../extreme_months/extreme_months.html">Extreme months</a></li>
<li class="toctree-l1"><a class="reference internal" href="../north_american_severe_weather/nasw.html">North American severe weather</a></li>
<li class="toctree-l1"><a class="reference internal" href="../australian_east_coast_lows/aecl.html">Australian east coast lows</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cold_surges/cold_surges.html">Cold Surges</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../DWR_validation/January_1872/january_1872.html">Validation against observations for January 1872</a></li>
<li class="toctree-l1"><a class="reference internal" href="../DWR_validation/Spring_1903/spring_1903.html">Validation against observations for Spring 1903</a></li>
<li class="toctree-l1"><a class="reference internal" href="../DWR_validation/February_1953/february_1953.html">Validation against observations for February 1953</a></li>
<li class="toctree-l1"><a class="reference internal" href="../DWR_validation/comparison.html">Validation Spread v. Error plot January 1872 + Spring 1903 + February 1953</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Observations coverage video</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fog_videos/1903.html">Weather and fog in 1903</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fog_videos/1931.html">Weather and fog in 1931</a></li>
<li class="toctree-l1"><a class="reference internal" href="../fog_videos/1880_Arctic.html">Weather and fog in the Arctic in 1880 and 1881</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../credits.html">Authors and acknowledgements</a></li>
</ul>
<h3><a href="https://github.com/oldweather/20CRv3-diagnostics">Get a copy</a></h3>

<ul>
<li><a href="https://github.com/oldweather/20CRv3-diagnostics"
           rel="nofollow">Github repository</a></li>
</ul>

<h3>Found a bug, or have a suggestion?</h3>

Please <a href="https://github.com/oldweather/20CRv3-diagnostics/issues/new">raise an issue</a>.
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="observations-coverage-video">
<h1>Observations coverage video<a class="headerlink" href="#observations-coverage-video" title="Permalink to this headline">¶</a></h1>
<center>
<table><tr><td><center>
<iframe src="https://player.vimeo.com/video/364280156?title=0&byline=0&portrait=0" width="795" height="448" frameborder="0" webkitallowfullscreen mozallowfullscreen allowfullscreen></iframe></center></td></tr>
<tr><td><center>Locations with observations</center></td></tr>
</table>
</center><p>In each 1x1 degree grid-cell, a bright yellow circle is shown if at least one pressure observation is available every 6 hours (one in each assimilation run). Paler yellow circles indicate observations in some, but not all assimilation periods (partial coverage). Each frame covers a 10-day period.</p>
<div class="line-block">
<div class="line"><br /></div>
</div>
<div class="section" id="code-to-make-the-figure">
<h2>Code to make the figure<a class="headerlink" href="#code-to-make-the-figure" title="Permalink to this headline">¶</a></h2>
<p>Script to make an individual frame - takes year, month, day, and hour as command-line options:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>

<span class="c1"># Observations coverage in 20CRv3</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">datetime</span>

<span class="kn">import</span> <span class="nn">iris</span>
<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">pandas</span>

<span class="kn">import</span> <span class="nn">matplotlib</span>
<span class="kn">from</span> <span class="nn">matplotlib.backends.backend_agg</span> <span class="kn">import</span> <span class="n">FigureCanvasAgg</span> <span class="k">as</span> <span class="n">FigureCanvas</span>
<span class="kn">from</span> <span class="nn">matplotlib.figure</span> <span class="kn">import</span> <span class="n">Figure</span>
<span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="kn">import</span> <span class="n">Rectangle</span>
<span class="kn">from</span> <span class="nn">matplotlib.lines</span> <span class="kn">import</span> <span class="n">Line2D</span>


<span class="c1"># Fix dask SPICE bug</span>
<span class="kn">import</span> <span class="nn">dask</span>
<span class="n">dask</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">scheduler</span><span class="o">=</span><span class="s1">&#39;single-threaded&#39;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">argparse</span>
<span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">()</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--year&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Year&quot;</span><span class="p">,</span>
                    <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--month&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Integer month&quot;</span><span class="p">,</span>
                    <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--day&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Day of month&quot;</span><span class="p">,</span>
                    <span class="nb">type</span><span class="o">=</span><span class="nb">int</span><span class="p">,</span><span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--hour&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Time of day (0 to 23.99)&quot;</span><span class="p">,</span>
                    <span class="n">default</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                    <span class="nb">type</span><span class="o">=</span><span class="nb">float</span><span class="p">,</span><span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span><span class="s2">&quot;--opdir&quot;</span><span class="p">,</span> <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Directory for output files&quot;</span><span class="p">,</span>
                    <span class="n">default</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/images/20CRv3_observations&quot;</span> <span class="o">%</span> \
                                           <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;SCRATCH&#39;</span><span class="p">),</span>
                    <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span><span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">opdir</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">opdir</span><span class="p">)</span>

<span class="n">dte</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">year</span><span class="p">,</span><span class="n">args</span><span class="o">.</span><span class="n">month</span><span class="p">,</span><span class="n">args</span><span class="o">.</span><span class="n">day</span><span class="p">,</span>
                      <span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">hour</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">hour</span><span class="o">%</span><span class="mi">1</span><span class="o">*</span><span class="mi">60</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">load_observations_1file</span><span class="p">(</span><span class="n">of_name</span><span class="p">):</span>
    <span class="n">compression</span><span class="o">=</span><span class="s1">&#39;infer&#39;</span>
    <span class="k">if</span> <span class="n">of_name</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:]</span><span class="o">==</span><span class="s1">&#39;gz&#39;</span><span class="p">:</span> <span class="n">compression</span><span class="o">=</span><span class="s1">&#39;gzip&#39;</span>
    <span class="n">o</span><span class="o">=</span><span class="n">pandas</span><span class="o">.</span><span class="n">read_fwf</span><span class="p">(</span><span class="n">of_name</span><span class="p">,</span>
                       <span class="n">colspecs</span><span class="o">=</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span><span class="mi">19</span><span class="p">),</span>
                                 <span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">50</span><span class="p">),</span>
                                 <span class="p">(</span><span class="mi">52</span><span class="p">,</span><span class="mi">64</span><span class="p">),</span>
                                 <span class="p">(</span><span class="mi">66</span><span class="p">,</span><span class="mi">68</span><span class="p">),</span>
                                 <span class="p">(</span><span class="mi">69</span><span class="p">,</span><span class="mi">72</span><span class="p">),</span>
                                 <span class="p">(</span><span class="mi">74</span><span class="p">,</span><span class="mi">80</span><span class="p">),</span>
                                 <span class="p">(</span><span class="mi">81</span><span class="p">,</span><span class="mi">87</span><span class="p">),</span>
                                 <span class="p">(</span><span class="mi">88</span><span class="p">,</span><span class="mi">95</span><span class="p">),</span>
                                 <span class="p">(</span><span class="mi">97</span><span class="p">,</span><span class="mi">102</span><span class="p">),</span>
                                 <span class="p">(</span><span class="mi">103</span><span class="p">,</span><span class="mi">110</span><span class="p">),</span>
                                 <span class="p">(</span><span class="mi">111</span><span class="p">,</span><span class="mi">112</span><span class="p">),</span>
                                 <span class="p">(</span><span class="mi">113</span><span class="p">,</span><span class="mi">123</span><span class="p">),</span>
                                 <span class="p">(</span><span class="mi">124</span><span class="p">,</span><span class="mi">134</span><span class="p">),</span>
                                 <span class="p">(</span><span class="mi">135</span><span class="p">,</span><span class="mi">145</span><span class="p">),</span>
                                 <span class="p">(</span><span class="mi">146</span><span class="p">,</span><span class="mi">156</span><span class="p">),</span>
                                 <span class="p">(</span><span class="mi">157</span><span class="p">,</span><span class="mi">167</span><span class="p">),</span>
                                 <span class="p">(</span><span class="mi">168</span><span class="p">,</span><span class="mi">175</span><span class="p">),</span>
                                 <span class="p">(</span><span class="mi">176</span><span class="p">,</span><span class="mi">183</span><span class="p">),</span>
                                 <span class="p">(</span><span class="mi">184</span><span class="p">,</span><span class="mi">191</span><span class="p">),</span>
                                 <span class="p">(</span><span class="mi">192</span><span class="p">,</span><span class="mi">200</span><span class="p">),</span>
                                 <span class="p">(</span><span class="mi">201</span><span class="p">,</span><span class="mi">205</span><span class="p">),</span>
                                 <span class="p">(</span><span class="mi">206</span><span class="p">,</span><span class="mi">213</span><span class="p">),</span>
                                 <span class="p">(</span><span class="mi">214</span><span class="p">,</span><span class="mi">221</span><span class="p">),</span>
                                 <span class="p">(</span><span class="mi">222</span><span class="p">,</span><span class="mi">223</span><span class="p">)],</span>
                       <span class="n">header</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;ISO-8859-1&quot;</span><span class="p">,</span>
                       <span class="n">compression</span><span class="o">=</span><span class="n">compression</span><span class="p">,</span>
                       <span class="n">usecols</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">],</span>
                       <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;UID&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;Name&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;ID&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;Type&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;NCEP.Type&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;Longitude&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;Latitude&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;Observed&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;Time.offset&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;Observed.2&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;Skipped&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;Bias.correction&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;Obfit.prior&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;Obfit.post&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;Obsprd.prior&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;Obsprd.post&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;Oberrvar.orig.out&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;Oberrvar.out&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;Oberrvar.use&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;Paoverpb.save&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;Prob.gross.error&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;Localization.length.scale&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;Lnsigl&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;QC.failure.flag&#39;</span><span class="p">],</span>
                       <span class="n">converters</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;UID&#39;</span><span class="p">:</span>  <span class="nb">str</span><span class="p">,</span>
                                   <span class="s1">&#39;Name&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                   <span class="s1">&#39;ID&#39;</span><span class="p">:</span>   <span class="nb">str</span><span class="p">,</span>
                                   <span class="s1">&#39;Type&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
                                   <span class="s1">&#39;NCEP.Type&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                                   <span class="s1">&#39;Longitude&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                                   <span class="s1">&#39;Latitude&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                                   <span class="s1">&#39;Observed&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                                   <span class="s1">&#39;Time.offset&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                                   <span class="s1">&#39;Observed.2&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                                   <span class="s1">&#39;Skipped&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                                   <span class="s1">&#39;Bias.correction&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                                   <span class="s1">&#39;Obfit.prior&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                                   <span class="s1">&#39;Obfit.post&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                                   <span class="s1">&#39;Obsprd.prior&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                                   <span class="s1">&#39;Obsprd.post&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                                   <span class="s1">&#39;Oberrvar.orig.out&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                                   <span class="s1">&#39;Oberrvar.out&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                                   <span class="s1">&#39;Oberrvar.use&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                                   <span class="s1">&#39;Paoverpb.save&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                                   <span class="s1">&#39;Prob.gross.error&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                                   <span class="s1">&#39;Localization.length.scale&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                                   <span class="s1">&#39;Lnsigl&#39;</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                                   <span class="s1">&#39;QC.failure.flag&#39;</span><span class="p">:</span> <span class="nb">int</span><span class="p">},</span>
                       <span class="n">na_values</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;NA&#39;</span><span class="p">,</span><span class="s1">&#39;*&#39;</span><span class="p">,</span><span class="s1">&#39;***&#39;</span><span class="p">,</span><span class="s1">&#39;*****&#39;</span><span class="p">,</span><span class="s1">&#39;*******&#39;</span><span class="p">,</span><span class="s1">&#39;**********&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;-99&#39;</span><span class="p">,</span><span class="s1">&#39;9999&#39;</span><span class="p">,</span><span class="s1">&#39;-999&#39;</span><span class="p">,</span><span class="s1">&#39;9999.99&#39;</span><span class="p">,</span><span class="s1">&#39;10000.0&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;-9.99&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;999999999999&#39;</span><span class="p">,</span><span class="s1">&#39;9&#39;</span><span class="p">],</span>
                       <span class="n">comment</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">return</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>

<span class="c1"># Load the obs for +-15 days around given datetime</span>
<span class="c1"># Get the fraction of assimilation points with at least</span>
<span class="c1">#  1 ob for each 1x1 degree grid-cell.</span>
<span class="n">n_fields</span><span class="o">=</span><span class="mi">0</span>
<span class="n">width</span><span class="o">=</span><span class="mi">360</span>
<span class="n">height</span><span class="o">=</span><span class="mi">180</span>
<span class="n">xmin</span><span class="o">=-</span><span class="mi">180</span>
<span class="n">xmax</span><span class="o">=</span><span class="mi">180</span>
<span class="n">ymin</span><span class="o">=-</span><span class="mi">90</span>
<span class="n">ymax</span><span class="o">=</span><span class="mi">90</span>
<span class="n">n_obs</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">width</span><span class="p">,</span><span class="n">height</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">x_to_i</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">width</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">numpy</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> 
            <span class="n">numpy</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="n">x</span><span class="o">-</span><span class="n">xmin</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">xmax</span><span class="o">-</span><span class="n">xmin</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">width</span><span class="o">-</span><span class="mi">1</span><span class="p">))))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">y_to_j</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">numpy</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">height</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">numpy</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> 
            <span class="n">numpy</span><span class="o">.</span><span class="n">floor</span><span class="p">((</span><span class="n">y</span><span class="o">-</span><span class="n">ymin</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">ymax</span><span class="o">-</span><span class="n">ymin</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">height</span><span class="o">-</span><span class="mi">1</span><span class="p">))))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">i_to_x</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">xmin</span> <span class="o">+</span> <span class="p">((</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">width</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">xmax</span><span class="o">-</span><span class="n">xmin</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">j_to_y</span><span class="p">(</span><span class="n">j</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">ymin</span> <span class="o">+</span> <span class="p">((</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">height</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">ymax</span><span class="o">-</span><span class="n">ymin</span><span class="p">)</span>
<span class="n">ct</span><span class="o">=</span><span class="n">dte</span><span class="o">-</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">et</span><span class="o">=</span><span class="n">dte</span><span class="o">+</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="k">while</span> <span class="n">ct</span><span class="o">&lt;</span><span class="n">et</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">ct</span><span class="o">.</span><span class="n">hour</span><span class="o">%</span><span class="mi">6</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
        <span class="n">ofile</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/20CR/version_3/v3_observations/</span><span class="si">%04d</span><span class="s2">/</span><span class="si">%04d%02d%02d%02d</span><span class="s2">_psobs_posterior.txt&quot;</span> <span class="o">%</span> <span class="p">(</span>
                                     <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;SCRATCH&#39;</span><span class="p">),</span><span class="n">ct</span><span class="o">.</span><span class="n">year</span><span class="p">,</span><span class="n">ct</span><span class="o">.</span><span class="n">year</span><span class="p">,</span><span class="n">ct</span><span class="o">.</span><span class="n">month</span><span class="p">,</span><span class="n">ct</span><span class="o">.</span><span class="n">day</span><span class="p">,</span><span class="n">ct</span><span class="o">.</span><span class="n">hour</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">ofile</span><span class="p">):</span>
            <span class="n">ofile</span><span class="o">+=</span><span class="s1">&#39;.gz&#39;</span>
        <span class="n">obs</span><span class="o">=</span><span class="n">load_observations_1file</span><span class="p">(</span><span class="n">ofile</span><span class="p">)</span>
        <span class="n">longs</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;Longitude&#39;</span><span class="p">])</span>
        <span class="n">lats</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;Latitude&#39;</span><span class="p">])</span>
        <span class="n">w</span><span class="o">=</span><span class="p">((</span><span class="n">numpy</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">longs</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">lats</span><span class="p">))</span> <span class="o">&amp;</span>
                    <span class="p">(</span><span class="n">longs</span><span class="o">&gt;=</span><span class="n">xmin</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">longs</span> <span class="o">&lt;=</span><span class="mi">360</span><span class="p">)</span> <span class="o">&amp;</span>
                    <span class="p">(</span><span class="n">lats</span><span class="o">&gt;=</span><span class="n">ymin</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">lats</span> <span class="o">&lt;=</span><span class="n">ymax</span><span class="p">))</span>
        <span class="n">longs</span><span class="o">=</span><span class="n">longs</span><span class="p">[</span><span class="n">w</span><span class="p">]</span>
        <span class="n">lats</span><span class="o">=</span><span class="n">lats</span><span class="p">[</span><span class="n">w</span><span class="p">]</span>
        <span class="n">longs</span><span class="p">[</span><span class="n">longs</span><span class="o">&gt;</span><span class="mi">180</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">360</span>
        <span class="n">lon_i</span><span class="o">=</span><span class="n">x_to_i</span><span class="p">(</span><span class="n">longs</span><span class="p">)</span>
        <span class="n">lat_i</span><span class="o">=</span><span class="n">y_to_j</span><span class="p">(</span><span class="n">lats</span><span class="p">)</span>
        <span class="n">n_add</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="n">width</span><span class="p">,</span><span class="n">height</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lon_i</span><span class="p">)):</span>
            <span class="n">n_add</span><span class="p">[</span><span class="n">lon_i</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">lat_i</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">n_obs</span> <span class="o">+=</span> <span class="n">n_add</span>
        <span class="n">n_fields</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">ct</span> <span class="o">+=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">hours</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">n_obs</span> <span class="o">/=</span> <span class="n">n_fields</span>

<span class="c1"># Load a land mask</span>
<span class="n">mask</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">load_cube</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/fixed_fields/land_mask/opfc_global_2019.nc&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;DATADIR&#39;</span><span class="p">))</span>

<span class="c1"># Define the figure (page size, background color, resolution, ...</span>
<span class="n">fig</span><span class="o">=</span><span class="n">Figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mf">19.2</span><span class="p">,</span><span class="mf">10.8</span><span class="p">),</span>              <span class="c1"># Width, Height (inches)</span>
           <span class="n">dpi</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
           <span class="n">facecolor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
           <span class="n">edgecolor</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
           <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
           <span class="n">frameon</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>                <span class="c1"># Don&#39;t draw a frame</span>
           <span class="n">subplotpars</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
           <span class="n">tight_layout</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">set_frameon</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span> 
<span class="c1"># Attach a canvas</span>
<span class="n">canvas</span><span class="o">=</span><span class="n">FigureCanvas</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

<span class="c1"># Projection for plotting</span>
<span class="n">cs</span><span class="o">=</span><span class="n">iris</span><span class="o">.</span><span class="n">coord_systems</span><span class="o">.</span><span class="n">RotatedGeogCS</span><span class="p">(</span><span class="mi">90</span><span class="p">,</span><span class="mi">180</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">plot_cube</span><span class="p">(</span><span class="n">resolution</span><span class="p">):</span>

    <span class="n">lat_values</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span><span class="n">ymax</span><span class="o">+</span><span class="n">resolution</span><span class="p">,</span><span class="n">resolution</span><span class="p">)</span>
    <span class="n">latitude</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">DimCoord</span><span class="p">(</span><span class="n">lat_values</span><span class="p">,</span>
                                    <span class="n">standard_name</span><span class="o">=</span><span class="s1">&#39;latitude&#39;</span><span class="p">,</span>
                                    <span class="n">units</span><span class="o">=</span><span class="s1">&#39;degrees_north&#39;</span><span class="p">,</span>
                                    <span class="n">coord_system</span><span class="o">=</span><span class="n">cs</span><span class="p">)</span>
    <span class="n">lon_values</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span><span class="n">xmax</span><span class="o">+</span><span class="n">resolution</span><span class="p">,</span><span class="n">resolution</span><span class="p">)</span>
    <span class="n">longitude</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">DimCoord</span><span class="p">(</span><span class="n">lon_values</span><span class="p">,</span>
                                     <span class="n">standard_name</span><span class="o">=</span><span class="s1">&#39;longitude&#39;</span><span class="p">,</span>
                                     <span class="n">units</span><span class="o">=</span><span class="s1">&#39;degrees_east&#39;</span><span class="p">,</span>
                                     <span class="n">coord_system</span><span class="o">=</span><span class="n">cs</span><span class="p">)</span>
    <span class="n">dummy_data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">lat_values</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">lon_values</span><span class="p">)))</span>
    <span class="n">plot_cube</span> <span class="o">=</span> <span class="n">iris</span><span class="o">.</span><span class="n">cube</span><span class="o">.</span><span class="n">Cube</span><span class="p">(</span><span class="n">dummy_data</span><span class="p">,</span>
                               <span class="n">dim_coords_and_dims</span><span class="o">=</span><span class="p">[(</span><span class="n">latitude</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
                                                    <span class="p">(</span><span class="n">longitude</span><span class="p">,</span> <span class="mi">1</span><span class="p">)])</span>
    <span class="k">return</span> <span class="n">plot_cube</span>


<span class="c1"># Define an axes to contain the plot. In this case our axes covers</span>
<span class="c1">#  the whole figure</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_axis_off</span><span class="p">()</span> <span class="c1"># Don&#39;t want surrounding x and y axis</span>

<span class="c1"># Lat and lon range (in rotated-pole coordinates) for plot</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span><span class="n">xmax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span><span class="n">ymax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>

<span class="c1"># Background</span>
<span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">Rectangle</span><span class="p">((</span><span class="n">xmin</span><span class="p">,</span><span class="n">ymin</span><span class="p">),</span><span class="n">width</span><span class="p">,</span><span class="n">height</span><span class="p">,</span><span class="n">facecolor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span><span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

<span class="c1"># Draw lines of latitude and longitude</span>
<span class="k">for</span> <span class="n">lat</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span><span class="mi">95</span><span class="p">,</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">lwd</span><span class="o">=</span><span class="mf">0.25</span>
    <span class="n">x</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">y</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">lon</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span><span class="mi">181</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">rp</span><span class="o">=</span><span class="n">iris</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">cartography</span><span class="o">.</span><span class="n">rotate_pole</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lon</span><span class="p">),</span>
                                                 <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lat</span><span class="p">),</span>
                                                 <span class="mi">180</span><span class="p">,</span>
                                                 <span class="mi">90</span><span class="p">)</span>
        <span class="n">nx</span><span class="o">=</span><span class="n">rp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">nx</span><span class="o">&gt;</span><span class="mi">180</span><span class="p">:</span> <span class="n">nx</span> <span class="o">-=</span> <span class="mi">360</span>
        <span class="n">ny</span><span class="o">=</span><span class="n">rp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">nx</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">&lt;</span><span class="mi">10</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ny</span><span class="o">-</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">&lt;</span><span class="mi">10</span><span class="p">)):</span>
            <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nx</span><span class="p">)</span>
            <span class="n">y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ny</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">Line2D</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">lwd</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mf">0.4</span><span class="p">,</span><span class="mf">0.4</span><span class="p">,</span><span class="mf">0.4</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
                               <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>
            <span class="n">x</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">y</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">):</span>        
        <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">Line2D</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">lwd</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mf">0.4</span><span class="p">,</span><span class="mf">0.4</span><span class="p">,</span><span class="mf">0.4</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
                           <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>

<span class="k">for</span> <span class="n">lon</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span><span class="mi">185</span><span class="p">,</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">lwd</span><span class="o">=</span><span class="mf">0.25</span>
    <span class="n">x</span><span class="o">=</span><span class="p">[]</span>
    <span class="n">y</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">lat</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span><span class="mi">90</span><span class="p">,</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">rp</span><span class="o">=</span><span class="n">iris</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">cartography</span><span class="o">.</span><span class="n">rotate_pole</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lon</span><span class="p">),</span>
                                                 <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">lat</span><span class="p">),</span>
                                                 <span class="mi">180</span><span class="p">,</span>
                                                 <span class="mi">90</span><span class="p">)</span>
        <span class="n">nx</span><span class="o">=</span><span class="n">rp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">nx</span><span class="o">&gt;</span><span class="mi">180</span><span class="p">:</span> <span class="n">nx</span> <span class="o">-=</span> <span class="mi">360</span>
        <span class="n">ny</span><span class="o">=</span><span class="n">rp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">nx</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">&lt;</span><span class="mi">10</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ny</span><span class="o">-</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">&lt;</span><span class="mi">10</span><span class="p">)):</span>
            <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nx</span><span class="p">)</span>
            <span class="n">y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ny</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">Line2D</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">lwd</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mf">0.4</span><span class="p">,</span><span class="mf">0.4</span><span class="p">,</span><span class="mf">0.4</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
                               <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>
            <span class="n">x</span><span class="o">=</span><span class="p">[]</span>
            <span class="n">y</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">):</span>        
        <span class="n">ax</span><span class="o">.</span><span class="n">add_line</span><span class="p">(</span><span class="n">Line2D</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">lwd</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="mf">0.4</span><span class="p">,</span><span class="mf">0.4</span><span class="p">,</span><span class="mf">0.4</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
                           <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">))</span>

<span class="c1"># Plot the land mask</span>
<span class="n">mask_pc</span><span class="o">=</span><span class="n">plot_cube</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>   
<span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">regrid</span><span class="p">(</span><span class="n">mask_pc</span><span class="p">,</span><span class="n">iris</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">Linear</span><span class="p">())</span>
<span class="n">lats</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">coord</span><span class="p">(</span><span class="s1">&#39;latitude&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">points</span>
<span class="n">lons</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">coord</span><span class="p">(</span><span class="s1">&#39;longitude&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">points</span>
<span class="n">mask_img</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">pcolorfast</span><span class="p">(</span><span class="n">lons</span><span class="p">,</span> <span class="n">lats</span><span class="p">,</span> <span class="n">mask</span><span class="o">.</span><span class="n">data</span><span class="p">,</span>
                         <span class="n">cmap</span><span class="o">=</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">ListedColormap</span><span class="p">(</span>
                                <span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
                                 <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">))),</span>
                         <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                         <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                         <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                         <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

<span class="c1"># Plot the observations locations</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">width</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">height</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">n_obs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span> <span class="k">continue</span>
        <span class="n">rp</span><span class="o">=</span><span class="n">iris</span><span class="o">.</span><span class="n">analysis</span><span class="o">.</span><span class="n">cartography</span><span class="o">.</span><span class="n">rotate_pole</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">i_to_x</span><span class="p">(</span><span class="n">i</span><span class="p">)),</span>
                                                 <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">j_to_y</span><span class="p">(</span><span class="n">j</span><span class="p">)),</span>
                                                 <span class="mi">180</span><span class="p">,</span>
                                                 <span class="mi">90</span><span class="p">)</span>
        <span class="n">nlon</span><span class="o">=</span><span class="n">rp</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">nlat</span><span class="o">=</span><span class="n">rp</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">matplotlib</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="n">nlon</span><span class="p">,</span><span class="n">nlat</span><span class="p">),</span>
                                                <span class="n">radius</span><span class="o">=</span><span class="mf">0.49</span><span class="p">,</span>
                                                <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">,</span>
                                                <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">,</span>
                                                <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                                                <span class="n">alpha</span><span class="o">=</span><span class="nb">max</span><span class="p">(</span><span class="mf">0.15</span><span class="p">,</span><span class="n">n_obs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]),</span>
                                                <span class="n">zorder</span><span class="o">=</span><span class="mi">180</span><span class="p">))</span>

<span class="c1"># Label with the date</span>
<span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">xmax</span><span class="o">-</span><span class="n">width</span><span class="o">*</span><span class="mf">0.009</span><span class="p">,</span>
        <span class="n">ymax</span><span class="o">-</span><span class="n">height</span><span class="o">*</span><span class="mf">0.016</span><span class="p">,</span>
         <span class="s2">&quot;</span><span class="si">%04d</span><span class="s2">-</span><span class="si">%02d</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">year</span><span class="p">,</span><span class="n">args</span><span class="o">.</span><span class="n">month</span><span class="p">),</span>
         <span class="n">horizontalalignment</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span>
         <span class="n">verticalalignment</span><span class="o">=</span><span class="s1">&#39;top&#39;</span><span class="p">,</span>
         <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
         <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">facecolor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span><span class="mf">0.8</span><span class="p">,</span><span class="mf">0.8</span><span class="p">,</span><span class="mf">0.5</span><span class="p">),</span>
                   <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span>
                   <span class="n">boxstyle</span><span class="o">=</span><span class="s1">&#39;round&#39;</span><span class="p">,</span>
                   <span class="n">pad</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span>
         <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span>
         <span class="n">clip_on</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
         <span class="n">zorder</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>

<span class="c1"># Render the figure as a png</span>
<span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%04d%02d%02d</span><span class="s1">.png&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">opdir</span><span class="p">,</span><span class="n">args</span><span class="o">.</span><span class="n">year</span><span class="p">,</span>
                                     <span class="n">args</span><span class="o">.</span><span class="n">month</span><span class="p">,</span><span class="n">args</span><span class="o">.</span><span class="n">day</span><span class="p">))</span>
</pre></div>
</div>
<p>To make the video, it is necessary to run the script above hundreds of times - giving an image for every 10-day period. This script makes the list of commands needed to make all the images, which can be run <a class="reference external" href="http://brohan.org/offline_assimilation/tools/parallel.html">in parallel</a>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>

<span class="c1"># Make all the individual frames for a movie</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">datetime</span>

<span class="c1"># Where to put the output files</span>
<span class="n">opdir</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/slurm_output&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;SCRATCH&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">opdir</span><span class="p">):</span>
    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">opdir</span><span class="p">)</span>

<span class="c1"># Function to check if the job is already done for this timepoint</span>
<span class="k">def</span> <span class="nf">is_done</span><span class="p">(</span><span class="n">year</span><span class="p">,</span><span class="n">month</span><span class="p">,</span><span class="n">day</span><span class="p">):</span>
    <span class="n">op_file_name</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/images/20CRv3_observations/&quot;</span> <span class="o">+</span>
                  <span class="s2">&quot;</span><span class="si">%04d%02d%02d</span><span class="s2">.png&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">&#39;SCRATCH&#39;</span><span class="p">),</span>
                            <span class="n">year</span><span class="p">,</span><span class="n">month</span><span class="p">,</span><span class="n">day</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">op_file_name</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="kc">False</span>

<span class="n">f</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="s2">&quot;run.txt&quot;</span><span class="p">,</span><span class="s2">&quot;w+&quot;</span><span class="p">)</span>

<span class="n">start_day</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">1851</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">0</span><span class="p">)</span>
<span class="n">end_day</span>  <span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">2015</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">23</span><span class="p">)</span>

<span class="n">current_day</span><span class="o">=</span><span class="n">start_day</span>
<span class="k">while</span> <span class="n">current_day</span><span class="o">&lt;=</span><span class="n">end_day</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">is_done</span><span class="p">(</span><span class="n">current_day</span><span class="o">.</span><span class="n">year</span><span class="p">,</span><span class="n">current_day</span><span class="o">.</span><span class="n">month</span><span class="p">,</span>
                   <span class="n">current_day</span><span class="o">.</span><span class="n">day</span><span class="p">):</span>
        <span class="n">current_day</span><span class="o">=</span><span class="n">current_day</span><span class="o">+</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="k">continue</span>
    <span class="n">cmd</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;./plot_obs_coverage.py --year=</span><span class="si">%d</span><span class="s2"> --month=</span><span class="si">%d</span><span class="s2"> &quot;</span> <span class="o">+</span>
         <span class="s2">&quot;--day=</span><span class="si">%d</span><span class="s2"> &quot;</span><span class="o">+</span>
         <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span>
           <span class="n">current_day</span><span class="o">.</span><span class="n">year</span><span class="p">,</span><span class="n">current_day</span><span class="o">.</span><span class="n">month</span><span class="p">,</span>
             <span class="n">current_day</span><span class="o">.</span><span class="n">day</span><span class="p">)</span>
    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
    <span class="n">current_day</span><span class="o">=</span><span class="n">current_day</span><span class="o">+</span><span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

</pre></div>
</div>
<p>To turn the thousands of images into a movie, use <a class="reference external" href="http://www.ffmpeg.org">ffmpeg</a></p>
<div class="highlight-shell notranslate"><div class="highlight"><pre><span></span>ffmpeg -r <span class="m">24</span> -pattern_type glob -i 20CRv3_observations/<span class="se">\*</span>.png <span class="se">\</span>
       -c:v libx264 -threads <span class="m">16</span> -preset veryslow -tune film <span class="se">\</span>
       -profile:v high -level <span class="m">4</span>.2 -pix_fmt yuv420p <span class="se">\</span>
       -b:v 5M -maxrate 5M -bufsize 20M <span class="se">\</span>
       -c:a copy 20CRv3_observations.mp4
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../py-modindex.html" title="Python Module Index"
             >modules</a></li>
        <li class="right" >
          <a href="../fog_videos/1903.html" title="Weather and fog in 1903"
             >next</a> |</li>
        <li class="right" >
          <a href="../DWR_validation/comparison.html" title="Validation Spread v. Error plot January 1872 + Spring 1903 + February 1953"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">20CRv3</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    </div>
  </body>
</html>